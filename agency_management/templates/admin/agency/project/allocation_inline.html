{% load i18n admin_urls static %}
<div class="module" id="allocation-grid">
    <h2>Team Allocations</h2>
    
    {% if project and project.start_date and project.end_date %}
    <div class="allocation-info" style="margin: 10px 0; padding: 10px; background: #f0f0f0; border-radius: 4px;">
        <p style="margin: 5px 0;">
            <strong>Project Duration:</strong> 
            {{ project.start_date|date:"M Y" }} - {{ project.end_date|date:"M Y" }}
            ({{ project_months|length }} months)
        </p>
        {% if project.total_hours %}
        <p style="margin: 5px 0;">
            <strong>Total Hours:</strong> {{ project.total_hours|floatformat:0 }}
            | <strong>Allocated:</strong> <span id="total-allocated">0</span>
            | <strong>Remaining:</strong> <span id="remaining-hours">{{ project.total_hours|floatformat:0 }}</span>
        </p>
        {% endif %}
    </div>
    
    <div class="allocation-grid" style="overflow-x: auto;">
        <table class="allocation-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #79aec8;">
                    <th style="padding: 10px; text-align: left; color: white; position: sticky; left: 0; background: #79aec8; z-index: 10; min-width: 200px;">
                        Team Member
                    </th>
                    {% for year, month, date in project_months %}
                    <th style="padding: 10px; text-align: center; color: white; min-width: 80px;">
                        {{ date|date:"M" }}<br>{{ year }}
                    </th>
                    {% endfor %}
                    <th style="padding: 10px; text-align: center; color: white; min-width: 80px;">
                        Total
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for member in team_members %}
                <tr class="allocation-row" data-member-id="{{ member.id }}">
                    <td style="padding: 10px; border: 1px solid #ddd; position: sticky; left: 0; background: white; z-index: 5;">
                        <strong>{{ member.user.get_full_name|default:member.user.username }}</strong><br>
                        <small style="color: #666;">{{ member.get_role_display }} â€¢ ${{ member.hourly_rate|floatformat:0 }}/hr</small>
                    </td>
                    {% for year, month, date in project_months %}
                    <td style="padding: 5px; border: 1px solid #ddd; text-align: center;">
                        <input type="number" 
                               class="allocation-input"
                               data-member="{{ member.id }}"
                               data-year="{{ year }}"
                               data-month="{{ month }}"
                               data-rate="{{ member.hourly_rate }}"
                               value="0"
                               min="0"
                               step="0.5"
                               style="width: 60px; text-align: center;">
                    </td>
                    {% endfor %}
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">
                        <span class="member-total" data-member="{{ member.id }}">0</span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr style="background: #f5f5f5; font-weight: bold;">
                    <td style="padding: 10px; border: 1px solid #ddd;">Monthly Totals</td>
                    {% for year, month, date in project_months %}
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                        <span class="month-total" data-year="{{ year }}" data-month="{{ month }}">0</span>
                    </td>
                    {% endfor %}
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">
                        <span id="grand-total">0</span>
                    </td>
                </tr>
            </tfoot>
        </table>
    </div>
    
    <div class="allocation-actions" style="margin-top: 20px;">
        <button type="button" class="button" onclick="distributeEvenly()">
            Distribute Hours Evenly
        </button>
        <button type="button" class="button" onclick="clearAllocations()">
            Clear All
        </button>
        <button type="button" class="button default" onclick="saveAllocations()">
            Save Allocations
        </button>
    </div>
    {% else %}
    <p style="padding: 20px; background: #f9f9f9; border-radius: 4px;">
        Please set project start and end dates, then save the project to allocate team members.
    </p>
    {% endif %}
</div>

<style>
.allocation-table input[type="number"] {
    border: 1px solid #ddd;
    border-radius: 3px;
    padding: 4px;
}
.allocation-table input[type="number"]:focus {
    border-color: #79aec8;
    outline: none;
}
.allocation-table tr:hover {
    background-color: #f9f9f9;
}
</style>

<script>
// Load existing allocations
const existingAllocations = {{ existing_allocations|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const inputs = document.querySelectorAll('.allocation-input');
    const totalHours = {{ project.total_hours|default:0 }};
    
    // Load existing values
    Object.keys(existingAllocations).forEach(key => {
        const [memberId, year, month] = key.split('_');
        const input = document.querySelector(
            `.allocation-input[data-member="${memberId}"][data-year="${year}"][data-month="${month}"]`
        );
        if (input) {
            input.value = existingAllocations[key].hours;
        }
    });
    
    // Update totals when inputs change
    inputs.forEach(input => {
        input.addEventListener('input', updateTotals);
    });
    
    // Initial calculation
    updateTotals();
    
    function updateTotals() {
        let grandTotal = 0;
        const memberTotals = {};
        const monthTotals = {};
        
        inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            const memberId = input.dataset.member;
            const year = input.dataset.year;
            const month = input.dataset.month;
            const key = `${year}_${month}`;
            
            memberTotals[memberId] = (memberTotals[memberId] || 0) + value;
            monthTotals[key] = (monthTotals[key] || 0) + value;
            grandTotal += value;
        });
        
        // Display member totals
        Object.keys(memberTotals).forEach(memberId => {
            const element = document.querySelector(`.member-total[data-member="${memberId}"]`);
            if (element) {
                element.textContent = memberTotals[memberId].toFixed(1);
            }
        });
        
        // Display month totals
        Object.keys(monthTotals).forEach(key => {
            const [year, month] = key.split('_');
            const element = document.querySelector(`.month-total[data-year="${year}"][data-month="${month}"]`);
            if (element) {
                element.textContent = monthTotals[key].toFixed(1);
            }
        });
        
        // Display grand total
        document.getElementById('grand-total').textContent = grandTotal.toFixed(1);
        document.getElementById('total-allocated').textContent = grandTotal.toFixed(1);
        
        // Update remaining hours
        if (totalHours > 0) {
            const remaining = totalHours - grandTotal;
            const remainingElement = document.getElementById('remaining-hours');
            remainingElement.textContent = remaining.toFixed(1);
            remainingElement.style.color = remaining < 0 ? '#dc2626' : '#059669';
        }
    }
    
    // Distribute hours evenly
    window.distributeEvenly = function() {
        if (totalHours > 0) {
            const numInputs = inputs.length;
            const hoursPerCell = (totalHours / numInputs).toFixed(1);
            
            inputs.forEach(input => {
                input.value = hoursPerCell;
            });
            
            updateTotals();
        }
    };
    
    // Clear all allocations
    window.clearAllocations = function() {
        if (confirm('Clear all allocations?')) {
            inputs.forEach(input => {
                input.value = 0;
            });
            updateTotals();
        }
    };
    
    // Save allocations
    window.saveAllocations = function() {
        const allocations = [];
        
        inputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            if (value > 0) {
                allocations.push({
                    user_profile: input.dataset.member,
                    year: input.dataset.year,
                    month: input.dataset.month,
                    hours: value
                });
            }
        });
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Send to server
        fetch(`/admin/agency/project/{{ project.id }}/save-allocations/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ allocations: allocations })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('Allocations saved successfully!');
                // Reload the page to show updated data
                window.location.reload();
            } else {
                alert('Error saving allocations: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error saving allocations: ' + error);
        });
    };
});
</script>
