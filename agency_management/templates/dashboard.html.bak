<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Management Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // Utility function to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(value);
        }
        
        // Utility function to format numbers with commas
        function formatNumber(value) {
            return new Intl.NumberFormat('en-US').format(value);
        }
    </script>
</head>
<body class="bg-gray-100">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <h1 class="text-3xl font-bold text-gray-900">Agency Management</h1>
                        {% if company %}
                            <span class="ml-4 px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">{{ company.name }}</span>
                        {% endif %}
                    </div>
                    <div class="flex space-x-4">
                        <a href="/admin/" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                            <i class="fas fa-cog mr-2"></i>Admin
                        </a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            
            {% if error %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">
                    <strong>Error:</strong> {{ error }}
                </div>
            {% endif %}

            <!-- Key Metrics Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Current Month Revenue -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Current Month Revenue</p>
                            <p class="text-2xl font-bold text-green-600">
                                <script>document.write(formatCurrency({{ current_revenue|default:0 }}));</script>
                            </p>
                        </div>
                        <div class="ml-4">
                            <i class="fas fa-dollar-sign text-green-500 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Annual Revenue -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Annual Revenue ({{ current_year|default:2025 }})</p>
                            <p class="text-2xl font-bold text-blue-600">
                                <script>document.write(formatCurrency({{ total_annual_revenue|default:0 }}));</script>
                            </p>
                            <p class="text-sm text-gray-500">
                                Booked: <script>document.write(formatCurrency({{ annual_booked_revenue|default:0 }}));</script> | 
                                Forecast: <script>document.write(formatCurrency({{ annual_forecast_revenue|default:0 }}));</script>
                            </p>
                        </div>
                        <div class="ml-4">
                            <i class="fas fa-chart-line text-blue-500 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Operating Costs (Monthly) -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Operating Costs (Monthly)</p>
                            <p class="text-2xl font-bold text-red-600">
                                <script>document.write(formatCurrency({{ current_month_costs|default:0 }}));</script>
                            </p>
                            <div class="text-sm text-gray-500">
                                <div>Payroll: <script>document.write(formatCurrency({{ payroll_costs|default:0 }}));</script></div>
                                <div>Contractors: <script>document.write(formatCurrency({{ contractor_costs|default:0 }}));</script></div>
                                <div>Other: <script>document.write(formatCurrency({{ other_costs|default:0 }}));</script></div>
                            </div>
                        </div>
                        <div class="ml-4">
                            <i class="fas fa-money-bill-wave text-red-500 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Monthly Profit -->
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex items-center">
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-600">Monthly Profit</p>
                            <p class="text-2xl font-bold text-green-600">
                                <script>document.write(formatCurrency({{ monthly_profit|default:0 }}));</script>
                            </p>
                            <p class="text-sm text-gray-500">{{ monthly_profit_margin|default:0|floatformat:1 }}% margin</p>
                        </div>
                        <div class="ml-4">
                            <i class="fas fa-chart-pie text-green-500 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secondary Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                <!-- Active Clients -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-blue-600">
                            <script>document.write(formatNumber({{ total_clients|default:0 }}));</script>
                        </p>
                        <p class="text-sm text-gray-600">Active Clients</p>
                    </div>
                </div>

                <!-- Projects -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-purple-600">
                            <script>document.write(formatNumber({{ total_projects|default:0 }}));</script>
                        </p>
                        <p class="text-sm text-gray-600">Total Projects</p>
                        <p class="text-xs text-gray-500">
                            <script>document.write(formatNumber({{ booked_projects|default:0 }}));</script> booked | 
                            <script>document.write(formatNumber({{ forecast_projects|default:0 }}));</script> forecast
                        </p>
                    </div>
                </div>

                <!-- Team Size -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-orange-600">
                            <script>document.write(formatNumber({{ total_team_members|default:0 }}));</script>
                        </p>
                        <p class="text-sm text-gray-600">Team Members</p>
                    </div>
                </div>

                <!-- Annual Costs -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-red-600">
                            <script>document.write(formatCurrency({{ total_annual_costs|default:0 }}));</script>
                        </p>
                        <p class="text-sm text-gray-600">Annual Costs</p>
                    </div>
                </div>

                <!-- Annual Profit -->
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-center">
                        <p class="text-2xl font-bold text-green-600">
                            <script>document.write(formatCurrency({{ annual_profit|default:0 }}));</script>
                        </p>
                        <p class="text-sm text-gray-600">Annual Profit</p>
                        <p class="text-xs text-gray-500">{{ annual_profit_margin|default:0|floatformat:1 }}% margin</p>
                    </div>
                </div>
            </div>

            <!-- Revenue & Expenses Chart -->
            <div class="bg-white rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <div class="flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-900">Revenue & Operating Expenses</h2>
                        <div class="flex space-x-4">
                            <select id="yearSelect" class="border border-gray-300 rounded-md px-3 py-2">
                                <option value="2024">2024</option>
                                <option value="2025" selected>2025</option>
                                <option value="2026">2026</option>
                            </select>
                            <button id="refreshChart" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">
                                <i class="fas fa-refresh mr-2"></i>Refresh
                            </button>
                            <button id="debugChart" class="bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
                                <i class="fas fa-bug mr-2"></i>Debug
                            </button>
                        </div>
                    </div>
                </div>
                <div class="p-6">
                    <div class="relative h-96">
                        <canvas id="revenueChart"></canvas>
                    </div>
                    <div class="mt-4 flex justify-center space-x-6 text-sm">
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-green-500 rounded mr-2"></div>
                            <span>Booked Revenue</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-blue-500 rounded mr-2"></div>
                            <span>Forecasted Revenue</span>
                        </div>
                        <div class="flex items-center">
                            <div class="w-4 h-4 bg-red-500 rounded mr-2"></div>
                            <span>Operating Expenses</span>
                        </div>
                    </div>
                    <!-- Debug Info -->
                    <div id="debugInfo" class="mt-4 p-3 bg-gray-100 rounded text-xs text-gray-600" style="display: none;">
                        <strong>Debug Information:</strong>
                        <div id="debugContent"></div>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Project Management -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Project Management</h3>
                    <div class="space-y-3">
                        <a href="/admin/agency/project/add/" class="block w-full bg-blue-500 text-white text-center py-2 px-4 rounded-md hover:bg-blue-600">
                            <i class="fas fa-plus mr-2"></i>Add Project
                        </a>
                        <a href="{% url 'agency:projects_list' %}?revenue_type=booked" class="block w-full bg-green-500 text-white text-center py-2 px-4 rounded-md hover:bg-green-600">
                            <i class="fas fa-check mr-2"></i>View Booked Projects
                        </a>
                        <a href="{% url 'agency:projects_list' %}?revenue_type=forecast" class="block w-full bg-yellow-500 text-white text-center py-2 px-4 rounded-md hover:bg-yellow-600">
                            <i class="fas fa-clock mr-2"></i>View Forecast Projects
                        </a>
                    </div>
                </div>

                <!-- Team & Capacity -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Team & Capacity</h3>
                    <div class="space-y-3">
                        <a href="{% url 'agency:capacity_dashboard' %}" class="block w-full bg-purple-500 text-white text-center py-2 px-4 rounded-md hover:bg-purple-600">
                            <i class="fas fa-chart-bar mr-2"></i>View Capacity
                        </a>
                        <a href="/admin/agency/userprofile/add/" class="block w-full bg-indigo-500 text-white text-center py-2 px-4 rounded-md hover:bg-indigo-600">
                            <i class="fas fa-user-plus mr-2"></i>Add Team Member
                        </a>
                        <a href="{% url 'agency:team_list' %}" class="block w-full bg-blue-500 text-white text-center py-2 px-4 rounded-md hover:bg-blue-600">
                            <i class="fas fa-users mr-2"></i>View Team
                        </a>
                    </div>
                </div>

                <!-- Admin Tools -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Admin Tools</h3>
                    <div class="space-y-3">
                        <a href="/admin/" class="block w-full bg-gray-500 text-white text-center py-2 px-4 rounded-md hover:bg-gray-600">
                            <i class="fas fa-cog mr-2"></i>Django Admin
                        </a>
                        <a href="/admin/agency/" class="block w-full bg-gray-500 text-white text-center py-2 px-4 rounded-md hover:bg-gray-600">
                            <i class="fas fa-database mr-2"></i>Manage Data
                        </a>
                        <a href="{% url 'agency:clients_list' %}" class="block w-full bg-teal-500 text-white text-center py-2 px-4 rounded-md hover:bg-teal-600">
                            <i class="fas fa-building mr-2"></i>View Clients
                        </a>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        let revenueChart;
        let lastChartData = null;
        
        // Initialize revenue chart
        function initializeRevenueChart() {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Booked Revenue',
                        data: [],
                        borderColor: 'rgb(34, 197, 94)',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Forecasted Revenue',
                        data: [],
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'Operating Expenses',
                        data: [],
                        borderColor: 'rgb(239, 68, 68)',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderDash: [5, 5]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Revenue ($)'
                            },
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Load revenue chart data
        function loadRevenueData() {
            const year = document.getElementById('yearSelect').value;
            
            console.log(`Loading revenue data for year ${year}...`);
            
            fetch(`{% url 'agency:revenue_chart_data' %}?year=${year}`)
                .then(response => response.json())
                .then(data => {
                    console.log('Chart data received:', data);
                    lastChartData = data;
                    
                    revenueChart.data.labels = data.months;
                    revenueChart.data.datasets[0].data = data.booked;
                    revenueChart.data.datasets[1].data = data.forecast;
                    revenueChart.data.datasets[2].data = data.expenses || new Array(12).fill(0);
                    revenueChart.update();
                    
                    // Show some debug info
                    const totalBooked = data.booked.reduce((a, b) => a + b, 0);
                    const totalForecast = data.forecast.reduce((a, b) => a + b, 0);
                    const totalExpenses = (data.expenses || []).reduce((a, b) => a + b, 0);
                    console.log(`Total Booked: $${totalBooked}, Total Forecast: $${totalForecast}, Total Expenses: $${totalExpenses}`);
                })
                .catch(error => {
                    console.error('Error loading revenue data:', error);
                    // Use dummy data if API fails
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    revenueChart.data.labels = months;
                    revenueChart.data.datasets[0].data = [10000, 12000, 15000, 18000, 16000, 20000, 22000, 19000, 21000, 23000, 25000, 27000];
                    revenueChart.data.datasets[1].data = [5000, 8000, 12000, 15000, 18000, 16000, 19000, 21000, 24000, 26000, 28000, 30000];
                    revenueChart.data.datasets[2].data = [8000, 8000, 8000, 8000, 8000, 8000, 8000, 8000, 8000, 8000, 8000, 8000];
                    revenueChart.update();
                });
        }
        
        // Debug function
        function showDebugInfo() {
            const debugDiv = document.getElementById('debugInfo');
            const debugContent = document.getElementById('debugContent');
            
            if (debugDiv.style.display === 'none') {
                debugDiv.style.display = 'block';
                if (lastChartData) {
                    debugContent.innerHTML = `
                        <div><strong>Company:</strong> ${lastChartData.debug?.company || 'Unknown'}</div>
                        <div><strong>Year:</strong> ${lastChartData.year}</div>
                        <div><strong>Data Source:</strong> ${lastChartData.debug?.data_source || 'Unknown'}</div>
                        <div><strong>Total Booked:</strong> $${lastChartData.debug?.total_booked || 0}</div>
                        <div><strong>Total Forecast:</strong> $${lastChartData.debug?.total_forecast || 0}</div>
                        <div><strong>Total Expenses:</strong> $${lastChartData.debug?.total_expenses || 0}</div>
                        <div><strong>Booked Data:</strong> [${lastChartData.booked?.join(', ') || 'No data'}]</div>
                        <div><strong>Forecast Data:</strong> [${lastChartData.forecast?.join(', ') || 'No data'}]</div>
                        <div><strong>Expenses Data:</strong> [${lastChartData.expenses?.join(', ') || 'No data'}]</div>
                        ${lastChartData.error ? `<div><strong>Error:</strong> ${lastChartData.error}</div>` : ''}
                    `;
                } else {
                    debugContent.innerHTML = '<div>No chart data loaded yet</div>';
                }
            } else {
                debugDiv.style.display = 'none';
            }
        }
        
        // Event listeners
        document.getElementById('yearSelect').addEventListener('change', loadRevenueData);
        document.getElementById('refreshChart').addEventListener('click', loadRevenueData);
        document.getElementById('debugChart').addEventListener('click', showDebugInfo);
        
        // Initialize
        initializeRevenueChart();
        loadRevenueData();
    });
    </script>
</body>
</html>
